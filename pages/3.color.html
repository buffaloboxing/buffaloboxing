<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1"  charset="UTF-8">
    <title>3.配色预览</title>
    <style>
        body { font-family: 微软雅黑; padding: 20px; max-width: 750px; margin: 0 auto; }
        .title { font-size: 20px; font-weight: bold; margin: 20px 0; }
        .canvas-container {
            position: relative;
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f9f9f9;
            overflow: hidden;
        }
        .canvas-placeholder {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            color: #999; font-size: 14px; z-index: 1;
        }
        #canvasContainer { position: relative; width: 100%; height: 100%; }
        #canvasContainer canvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            image-rendering: pixelated;
        }
        .color-container {
            position: relative; margin-top: 10px; width: 100%;
            display: flex; flex-wrap: wrap; gap: 10px;
        }
        .color-circle {
            width: 30px; height: 30px; border-radius: 50%;
            cursor: pointer; box-shadow: 0 0 0 2px transparent;
            transition: all 0.2s;
        }
        .color-circle.selected {
            box-shadow: 0 0 0 2px #07c160, 0 0 0 4px rgba(7, 193, 96, 0.2);
            transform: scale(1.1);
        }
        .current-price { font-size: 16px; font-weight: bold; color: #333; margin: 10px 0; }
        .price-alert { padding: 10px; background: #fff1f0; border: 1px solid #ffa39e; border-radius: 6px; margin: 10px 0; color: #e83e3e; font-size: 14px; display: none; }
        .alert-box { padding: 12px; background: #fff8e1; border: 1px solid #ffe082; border-radius: 6px; margin: 10px 0; color: #e65100; font-size: 14px; }
        .color-rule { font-size: 14px; color: #666; margin: 5px 0; line-height: 1.5; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .prev-btn, .next-btn { flex: 1; padding: 15px; border-radius: 6px; cursor: pointer; font-size: 16px; }
        .prev-btn { background: #f5f5f5; color: #333; border: 1px solid #ddd; }
        .next-btn { background: #07c160; color: #fff; border: none; }
        .controls { margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px; }
        select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>
<div class="title">配色预览（选区域+颜色上色）</div>

<div class="current-price">当前价格：¥<span id="currentPrice">1699</span></div>
<div class="price-alert" id="priceAlert"></div>

<div class="canvas-container">
    <div class="canvas-placeholder">拳套预览图加载中...</div>
    <div id="canvasContainer"></div>
</div>

<div id="leatherTip" class="alert-box" style="display: none;"></div>

<div class="color-rules">
    <div class="color-rule">1、2、3号区域：可免费选择2种颜色，每额外增加1种+300元</div>
    <div class="color-rule">4、5、6、7、8号区域：可在免费2种颜色基础上再免费选1种，每额外增加1种+150元</div>
</div>

<div class="controls">
    <div>
        <label>选上色区域：</label>
        <select id="areaSelect">
            <option value="1">1 </option>
            <option value="2">2 </option>
            <option value="3">3 </option>
            <option value="4">4 </option>
            <option value="5">5 </option>
            <option value="6">6 </option>
            <option value="7">7 </option>
            <option value="8">8 </option>
        </select>
    </div>
    <div>
        <label>选颜色（点击颜色圆圈）：</label>
        <div class="color-container" id="colorContainer"></div>
    </div>
</div>

<div class="btn-group">
    <button class="prev-btn" id="prevBtn">上一页：选择皮革</button>
    <button class="next-btn" id="nextBtn">下一步：定制印字/图案</button>
</div>

<script>
    /* ==================== 首次进入清空染色状态 ==================== */
    const isFirstVisit = !localStorage.getItem('hasVisitedColorPage');
    if (isFirstVisit) {
        localStorage.removeItem('areaColors');
        localStorage.removeItem('colorExtra');
        localStorage.setItem('hasVisitedColorPage', 'true'); // 标记已访问
    }

    /* ==================== 22.html 染色核心逻辑 ==================== */
    const TOTAL_LAYERS = 8;
    const CANVAS_SIZE = { w: 1632, h: 1280 };

    const container = document.getElementById('canvasContainer');
    const placeholder = document.querySelector('.canvas-placeholder');
    const areaSelect = document.getElementById('areaSelect');
    const colorContainer = document.getElementById('colorContainer');
    const currentPriceEl = document.getElementById('currentPrice');
    const priceAlert = document.getElementById('priceAlert');
    const leatherTip = document.getElementById('leatherTip');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    let basePrice = parseInt(localStorage.getItem('basePrice')) || 1699;
    let colorExtra = 0;
    const areaColors = { '1': null, '2': null, '3': null, '4': null, '5': null, '6': null, '7': null, '8': null };

    const canvases = [], ctxs = [], images = [], tintedData = [];
    let selectedIdx = 0;

    // 创建 canvas
    for (let i = 0; i < TOTAL_LAYERS; i++) {
        const cvs = document.createElement('canvas');
        cvs.width = CANVAS_SIZE.w;
        cvs.height = CANVAS_SIZE.h;
        cvs.style.zIndex = TOTAL_LAYERS - i;
        container.appendChild(cvs);
        const ctx = cvs.getContext('2d');
        canvases.push(cvs);
        ctxs.push(ctx);
        tintedData.push(null);
    }

    function loadImage(src) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = () => reject(new Error(`加载失败: ${src}`));
            img.src = src;
        });
    }

    async function initImages() {
        const promises = [];
        for (let i = 1; i <= TOTAL_LAYERS; i++) {
            promises.push(loadImage(`..\\images\\${i}.png`));
        }
        const loaded = await Promise.all(promises);
        loaded.forEach((img, idx) => {
            images[idx] = img;
            renderLayer(idx); // 仅绘制原始图
        });
        placeholder.style.display = 'none';
    }

    function renderLayer(idx) {
        const ctx = ctxs[idx];
        ctx.clearRect(0, 0, CANVAS_SIZE.w, CANVAS_SIZE.h);
        const img = images[idx];
        ctx.drawImage(img, 0, 0);

        if (tintedData[idx]) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = CANVAS_SIZE.w;
            tempCanvas.height = CANVAS_SIZE.h;
            const tctx = tempCanvas.getContext('2d');
            tctx.drawImage(img, 0, 0);
            const alphaData = tctx.getImageData(0, 0, CANVAS_SIZE.w, CANVAS_SIZE.h);
            const tinted = tintedData[idx];

            for (let i = 0; i < alphaData.data.length; i += 4) {
                if (alphaData.data[i + 3] > 0) {
                    tinted.data[i + 3] = alphaData.data[i + 3];
                } else {
                    tinted.data[i + 3] = 0;
                }
            }
            ctx.putImageData(tinted, 0, 0);
        }
    }

    function tintLayer(idx, colorHex) {
        const ctx = ctxs[idx];
        const img = images[idx];
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, CANVAS_SIZE.w, CANVAS_SIZE.h);
        const data = imageData.data;

        const rTarget = parseInt(colorHex.slice(1, 3), 16);
        const gTarget = parseInt(colorHex.slice(3, 5), 16);
        const bTarget = parseInt(colorHex.slice(5, 7), 16);

        for (let i = 0; i < data.length; i += 4) {
            if (data[i + 3] === 0) continue;
            const srcR = data[i] / 255;
            const srcG = data[i + 1] / 255;
            const srcB = data[i + 2] / 255;
            data[i] = srcR * rTarget;
            data[i + 1] = srcG * gTarget;
            data[i + 2] = srcB * bTarget;
        }

        tintedData[idx] = imageData;
        renderLayer(idx);
    }

    /* ==================== 颜色选择 ==================== */
    const colors = [
        { code: '#FFFFFF', name: '纯白' }, { code: '#F5F0EB', name: '奶昔白' },
        { code: '#9D5F3B', name: '金棕' }, { code: '#746148', name: '大象灰' },
        { code: '#1E2E44', name: '午夜蓝' }, { code: '#000000', name: '黑色' },
        { code: '#80412D', name: '焦糖棕' }, { code: '#3FBF72', name: '漫画绿' },
        { code: '#B3A59A', name: '风衣灰' }, { code: '#F27D3C', name: '橙色' },
        { code: '#F2C12E', name: '太阳黄' }, { code: '#F9E77F', name: '小鸡黄' },
        { code: '#404234', name: '橄榄绿' }, { code: '#BDE0F2', name: '微风蓝' },
        { code: '#A0E7E5', name: 'tiffany蓝' }, { code: '#0D32C4', name: '克莱因蓝' },
        { code: '#91A3B1', name: '亚麻蓝' }, { code: '#C0A086', name: '马拉茶色' },
        { code: '#828776', name: '鼠尾草绿' }, { code: '#808080', name: '积雨云灰' },
        { code: '#BE3033', name: '大红' }, { code: '#EEB9C9', name: '樱花粉' },
        { code: '#DF6981', name: '蔷薇粉' }, { code: '#E4A3BB', name: '花瓣粉' },
        { code: '#6A2A30', name: '酒红' }, { code: '#FFD700', name: '柠檬黄' },
        { code: '#C6AEA6', name: '杏色' }, { code: '#294162', name: '深邃蓝' },
        { code: '#C0C0C0', name: '海鸥灰' }, { code: '#402D2D', name: '深咖' }
    ];

    function createColorCircles() {
        colorContainer.innerHTML = '';
        colors.forEach(color => {
            const circle = document.createElement('div');
            circle.className = 'color-circle';
            circle.style.backgroundColor = color.code;
            circle.title = color.name;
            circle.dataset.color = color.code;
            circle.onclick = () => {
                document.querySelectorAll('.color-circle').forEach(el => el.classList.remove('selected'));
                circle.classList.add('selected');
                const area = areaSelect.value;
                areaColors[area] = color.code;
                tintLayer(parseInt(area) - 1, color.code);
                calculatePrice();
            };
            colorContainer.appendChild(circle);
        });
    }

    areaSelect.addEventListener('change', () => {
        selectedIdx = parseInt(areaSelect.value) - 1;
        const currentColor = areaColors[areaSelect.value];
        document.querySelectorAll('.color-circle').forEach(el => {
            el.classList.toggle('selected', el.dataset.color === currentColor);
        });
    });

    /* ==================== 价格 & 提示逻辑 ==================== */
    function calculatePrice() {
        const leatherType = localStorage.getItem('leatherType') || '';
        const isWildCowhide = leatherType.includes('野牛皮');
        const area123Colors = new Set();
        const area45678Colors = new Set();

        for (let i = 1; i <= 8; i++) {
            const color = areaColors[i];
            if (!color) continue;
            if (isWildCowhide && color === '#80412D') continue;
            if (i <= 3) area123Colors.add(color);
            else area45678Colors.add(color);
        }

        const newColorsIn45678 = new Set();
        area45678Colors.forEach(c => !area123Colors.has(c) && newColorsIn45678.add(c));

        let extra = 0;
        let alertText = '';

        const area123Free = isWildCowhide ? 3 : 2;
        if (area123Colors.size > area123Free) {
            const over = area123Colors.size - area123Free;
            extra += over * 300;
            alertText += `1、2、3号区域已超额使用${over}种颜色，需额外支付${over * 300}元；`;
        }

        const area45678Free = isWildCowhide ? 2 : 1;
        if (newColorsIn45678.size > area45678Free) {
            const over = newColorsIn45678.size - area45678Free;
            extra += over * 150;
            alertText += `4、5、6、7、8号区域已超额使用${over}种颜色，需额外支付${over * 150}元；`;
        }

        priceAlert.textContent = alertText;
        priceAlert.style.display = alertText ? 'block' : 'none';

        colorExtra = extra;
        currentPriceEl.innerText = basePrice + colorExtra;
        localStorage.setItem('colorExtra', colorExtra);
        localStorage.setItem('areaColors', JSON.stringify(areaColors));
    }

    function showLeatherTip() {
        const leatherType = localStorage.getItem('leatherType') || '';
        if (leatherType.includes('野牛皮')) {
            leatherTip.textContent = '野牛皮固定为深棕色，您可以用深棕色代替野牛皮来进行搭配，且不计入两种普通牛皮的颜色额度';
            leatherTip.style.display = 'block';
        } else if (/鲨鱼|鳄鱼|鸵鸟|蜥蜴/.test(leatherType)) {
            leatherTip.textContent = '鳄鱼/鲨鱼/鸵鸟/蜥蜴等稀有皮革没有色卡，一般会有黑色、棕色?白色等常见颜色，您可以先用色卡上相似的颜色搭配，然后由我们来找找看有没有对应颜色的皮革（这种名贵稀有皮固定应用于 2、5 号区域，应用于其它区域需要联系客服报价）';
            leatherTip.style.display = 'block';
        } else {
            leatherTip.style.display = 'none';
        }
    }

    /* ==================== 导航 ==================== */
    prevBtn.onclick = () => { window.location.href = '2.leather.html'; };
    nextBtn.onclick = () => {
        localStorage.setItem('areaColors', JSON.stringify(areaColors));
        localStorage.setItem('colorExtra', colorExtra);
        window.location.href = '4.customize.html';
    };

    /* ==================== 初始化 ==================== */
    // 恢复颜色（非首次）
    const saved = localStorage.getItem('areaColors');
    if (saved && !isFirstVisit) {
        Object.assign(areaColors, JSON.parse(saved));
    }

    initImages().then(() => {
        createColorCircles();
        showLeatherTip();

        // 恢复染色（非首次）
        if (saved && !isFirstVisit) {
            setTimeout(() => {
                Object.keys(areaColors).forEach(area => {
                    const color = areaColors[area];
                    if (color) tintLayer(parseInt(area) - 1, color);
                });
                calculatePrice();
            }, 100);
        } else {
            calculatePrice(); // 首次进入：价格为 basePrice
        }
    }).catch(err => {
        console.error(err);
        placeholder.textContent = '图片加载失败，请确保 1.png ~ 8.png 存在';
    });
</script>
</body>
</html>
